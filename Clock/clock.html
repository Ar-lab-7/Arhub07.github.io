<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIUI Clock</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="MIUI Clock">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MIUI Clock">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#FF6900">
    
    <!-- Favicons (using an SVG data URI for a transparent, scalable icon) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNGRjY5MDAiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiLz4KPGxpbmUgeDE9IjEyIiB5MT0iMTIiIHgyPSIxMiIgeTI9IjYuNSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPGxpbmUgeDE9IjEyIiB5MT0iMTIiIHgyPSIxNi41IiB5Mj0iMTIuNSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+Cjwvc3ZnPg==">
    
    <!-- Manifest (PWA configuration for app installation) -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1JVUkgQ2xvY2siLAogICJzaG9ydF9uYW1lIjogIk1JVUkgQ2xvY2siLAogICJkZXNjcmlwdGlvbiI6ICJBIGZ1bGwtZmVhdHVyZWQgWGlhb21pIE1JVUkgc3R5bGUgY2xvY2sgYXBwIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwMDAwMDAiLAogICJ0aGVtZV9jb2xvciIgOiAiI0ZGNjkwMCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYTBpaU9UWWlJR2hsYVdkb2REMGlPVFlpSUhacFpYZENiM2c5SWpBZ01DQTlOaUE5TmlJaVptbHNiRDJpaWJtOXVaU0lnZUcxc2JuTjlJbWgwZEhBNkx5OTNkM2N1ZHpNdWIzSm5MelJ3TURBdklNMDJaeUlBZENqeGphWEpqYkdVZ1kzZzlJelU0SWlCamVUMGlOVElpSUhJOUlqRTBJSUJtYVd4c1BTSWpSa1kyT1RBd0lpOCtDbkJ6ZG1jZ2VEMGlNVEFpSUhrOUlqRTJJSUIzYVdSMGFEMGlNVEFpSUdobGFXZG9kRDBpTVRBd0lIWnBaWGRDYjNnOUlqQWdNQ0F4TkNBeE5DSWdabWxzYkQwaWJtOXVaU0krQ2p4amFYSmpiR1VnWTNnOUlqRTJJSUJqZVQwaU1USWlJSEk5SWpFd0lpQnpkSEp2YTJVOUluZG9hWFJsSWlCemRISnZhMlV0ZDJsa2RHZzlJaklpTHo0S1BHeHBibVVnZURFOUlqRTJJSUJBNU1qMGlOaUlnZURJNklqRTJJSUJBNU1qMGlNVElpSUhOMGNtOXJaVDBpZDJocGRHVWlJSFAwY205clpTMXphV1IwYTBpTWlJZ2MzUnliMnRsTFd4cGJtVmFZbVhBOUluSnZkVzVrSWi4oC9zdmc+Cjwvc3ZnPg==">
    
    <!-- Tailwind CSS for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <style>
        /* Import Inter font for a modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        /* Glassmorphism effect for cards/elements */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Custom gradients for dynamic elements */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-orange {
            background: linear-gradient(135deg, #FF6900 0%, #FCB900 100%);
        }
        
        .gradient-blue {
            background: linear-gradient(135deg, #00C9FF 0%, #92FE9D 100%);
        }
        
        .gradient-purple {
            background: linear-gradient(135deg, #A8EDEA 0%, #FED6E3 100%);
        }
        
        /* Digital font for clock displays */
        .digital-font {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        /* Analog clock hand transformations with smooth transitions */
        .clock-hand {
            transform-origin: 100px 100px; /* Set origin to the center of the SVG for rotation */
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); /* Smooth easing for transitions */
        }
        
        /* Pulse animation for notification dot */
        .notification-dot {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Fade-in animation for new elements */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Slide-up animation for modals */
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        /* Tab indicator animation */
        .tab-indicator {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* World clock item hover effect */
        .world-clock-item {
            transition: all 0.2s ease;
        }
        
        .world-clock-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* Hide number input arrows (for a cleaner look) */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen overflow-hidden flex flex-col">
    <!-- Notification Permission Banner (hidden by default, shown when permission needed) -->
    <div id="notificationBanner" class="hidden fixed top-0 left-0 right-0 z-50 bg-orange-500 text-white p-3 text-center">
        <div class="flex items-center justify-between max-w-md mx-auto">
            <span class="text-sm">Enable notifications for alarms and timers</span>
            <div class="flex gap-2">
                <button onclick="requestNotificationPermission()" class="bg-white text-orange-500 px-3 py-1 rounded text-xs font-medium">Allow</button>
                <button onclick="dismissNotificationBanner()" class="text-white opacity-70 hover:opacity-100">Ã—</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="h-screen flex flex-col">
        <!-- Header with Dynamic Logo and Settings -->
        <header class="flex items-center justify-between p-4 bg-gradient-to-r from-gray-900 to-black">
            <div class="flex items-center space-x-3">
                <div id="dynamicLogo" class="w-10 h-10 rounded-full gradient-orange flex items-center justify-center">
                    <!-- Icon updated by JavaScript based on time of day -->
                    <i class="fas fa-clock text-white text-lg"></i> 
                </div>
                <div>
                    <h1 class="text-xl font-bold">MIUI Clock</h1>
                    <p id="currentLocation" class="text-xs text-gray-400">Loading location...</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="toggleTheme()" class="p-2 rounded-full bg-gray-800 hover:bg-gray-700 transition-colors">
                    <i id="themeIcon" class="fas fa-moon text-gray-300"></i>
                </button>
                <button onclick="showSettings()" class="p-2 rounded-full bg-gray-800 hover:bg-gray-700 transition-colors">
                    <i class="fas fa-cog text-gray-300"></i>
                </button>
            </div>
        </header>

        <!-- Tab Navigation for Clock, Alarm, Stopwatch, Timer -->
        <nav class="flex bg-gray-900 relative">
            <div id="tabIndicator" class="absolute bottom-0 h-1 gradient-orange transition-all duration-300 rounded-t-full"></div>
            <button onclick="switchTab('clock')" class="flex-1 py-4 text-center text-sm font-medium text-gray-300 hover:text-white tab-btn active">
                <i class="fas fa-clock block mb-1"></i>
                Clock
            </button>
            <button onclick="switchTab('alarm')" class="flex-1 py-4 text-center text-sm font-medium text-gray-300 hover:text-white tab-btn">
                <i class="fas fa-bell block mb-1"></i>
                Alarm
            </button>
            <button onclick="switchTab('stopwatch')" class="flex-1 py-4 text-center text-sm font-medium text-gray-300 hover:text-white tab-btn">
                <i class="fas fa-stopwatch block mb-1"></i>
                Stopwatch
            </button>
            <button onclick="switchTab('timer')" class="flex-1 py-4 text-center text-sm font-medium text-gray-300 hover:text-white tab-btn">
                <i class="fas fa-hourglass-half block mb-1"></i>
                Timer
            </button>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto pb-20">
            <!-- Clock Tab Content -->
            <div id="clockTab" class="tab-content fade-in">
                <!-- Main Clock Display (Digital and Analog) -->
                <div class="p-6 text-center">
                    <div id="mainClock" class="mb-4">
                        <div id="digitalTime" class="text-6xl font-light digital-font mb-2">00:00:00</div>
                        <div id="digitalDate" class="text-lg text-gray-400 mb-1">Monday, January 1, 2024</div>
                        <div id="digitalTimezone" class="text-sm text-gray-500">UTC+0</div>
                    </div>
                    
                    <!-- Analog Clock SVG -->
                    <div class="flex justify-center mb-6">
                        <div class="relative">
                            <svg width="200" height="200">
                                <!-- Clock Face Circle -->
                                <circle cx="100" cy="100" r="95" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="2"/>
                                <!-- Hour Markers will be dynamically generated by JS -->
                                <g id="hourMarkers"></g>
                                <!-- Clock Hands (x1,y1 at center, x2,y2 determines length and initial direction) -->
                                <line id="hourHand" x1="100" y1="100" x2="100" y2="60" stroke="#FF6900" stroke-width="4" stroke-linecap="round" class="clock-hand"/>
                                <line id="minuteHand" x1="100" y1="100" x2="100" y2="40" stroke="#FFFFFF" stroke-width="3" stroke-linecap="round" class="clock-hand"/>
                                <line id="secondHand" x1="100" y1="100" x2="100" y2="30" stroke="#FF6900" stroke-width="1" stroke-linecap="round" class="clock-hand"/>
                                <!-- Center Dot -->
                                <circle cx="100" cy="100" r="6" fill="#FF6900"/>
                            </svg>
                        </div>
                    </div>
                    
                    <!-- Clock Face Style Selection -->
                    <div class="mb-6">
                        <h3 class="text-sm font-medium text-gray-400 mb-3">Clock Faces</h3>
                        <div class="flex justify-center space-x-3">
                            <button onclick="changeClockFace('digital')" class="clock-face-btn flex flex-col items-center p-3 rounded-xl bg-gray-800 text-gray-400 active" data-face="digital">
                                <i class="fas fa-digital-tachograph text-2xl mb-1"></i>
                                <span class="text-xs">Digital</span>
                            </button>
                            <button onclick="changeClockFace('analog')" class="clock-face-btn flex flex-col items-center p-3 rounded-xl bg-gray-800 text-gray-400" data-face="analog">
                                <i class="fas fa-clock text-2xl mb-1"></i>
                                <span class="text-xs">Analog</span>
                            </button>
                            <button onclick="changeClockFace('minimal')" class="clock-face-btn flex flex-col items-center p-3 rounded-xl bg-gray-800 text-gray-400" data-face="minimal">
                                <i class="fas fa-minus text-2xl mb-1"></i>
                                <span class="text-xs">Minimal</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- World Clocks Section -->
                <div class="px-4 pb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">World Clock</h3>
                        <button onclick="addWorldClock()" class="p-2 rounded-full bg-orange-500 hover:bg-orange-600 transition-colors">
                            <i class="fas fa-plus text-white text-sm"></i>
                        </button>
                    </div>
                    <div id="worldClocks" class="space-y-3">
                        <!-- World clocks will be populated here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Alarm Tab Content -->
            <div id="alarmTab" class="tab-content hidden fade-in">
                <div class="p-4">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold">Alarms</h2>
                        <button onclick="addAlarm()" class="bg-orange-500 hover:bg-orange-600 px-4 py-2 rounded-full text-sm font-medium transition-colors">
                            <i class="fas fa-plus mr-2"></i>Add Alarm
                        </button>
                    </div>
                    <div id="alarmsList" class="space-y-4">
                        <!-- Alarms will be populated here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Stopwatch Tab Content -->
            <div id="stopwatchTab" class="tab-content hidden fade-in">
                <div class="p-6 text-center">
                    <div class="mb-8">
                        <div id="stopwatchTime" class="text-7xl font-light digital-font mb-4">00:00.00</div>
                        <div id="lapTimes" class="text-sm text-gray-400 max-h-32 overflow-y-auto custom-scrollbar"></div>
                    </div>
                    <div class="flex justify-center space-x-4">
                        <button id="stopwatchReset" onclick="resetStopwatch()" class="bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded-full font-medium transition-colors">
                            Reset
                        </button>
                        <button id="stopwatchLap" onclick="lapStopwatch()" class="bg-blue-500 hover:bg-blue-600 px-6 py-3 rounded-full font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Lap
                        </button>
                        <button id="stopwatchStart" onclick="toggleStopwatch()" class="bg-green-500 hover:bg-green-600 px-6 py-3 rounded-full font-medium transition-colors">
                            Start
                        </button>
                    </div>
                </div>
            </div>

            <!-- Timer Tab Content -->
            <div id="timerTab" class="tab-content hidden fade-in">
                <div class="p-6">
                    <div class="text-center mb-8">
                        <div id="timerDisplay" class="text-7xl font-light digital-font mb-6">00:00:00</div>
                        
                        <!-- Timer Input Fields -->
                        <div id="timerInput" class="mb-6">
                            <div class="flex justify-center space-x-4 mb-4">
                                <div class="text-center">
                                    <input type="number" id="timerHours" min="0" max="23" value="0" class="w-16 h-16 text-2xl text-center bg-gray-800 rounded-lg border-2 border-gray-700 focus:border-orange-500 focus:outline-none custom-number-input">
                                    <div class="text-xs text-gray-500 mt-1">Hours</div>
                                </div>
                                <div class="text-center">
                                    <input type="number" id="timerMinutes" min="0" max="59" value="5" class="w-16 h-16 text-2xl text-center bg-gray-800 rounded-lg border-2 border-gray-700 focus:border-orange-500 focus:outline-none custom-number-input">
                                    <div class="text-xs text-gray-500 mt-1">Minutes</div>
                                </div>
                                <div class="text-center">
                                    <input type="number" id="timerSeconds" min="0" max="59" value="0" class="w-16 h-16 text-2xl text-center bg-gray-800 rounded-lg border-2 border-gray-700 focus:border-orange-500 focus:outline-none custom-number-input">
                                    <div class="text-xs text-gray-500 mt-1">Seconds</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Timer Buttons -->
                        <div class="grid grid-cols-4 gap-2 mb-6">
                            <button onclick="setQuickTimer(1)" class="bg-gray-800 hover:bg-gray-700 py-3 rounded-lg text-sm transition-colors">1m</button>
                            <button onclick="setQuickTimer(3)" class="bg-gray-800 hover:bg-gray-700 py-3 rounded-lg text-sm transition-colors">3m</button>
                            <button onclick="setQuickTimer(5)" class="bg-gray-800 hover:bg-gray-700 py-3 rounded-lg text-sm transition-colors">5m</button>
                            <button onclick="setQuickTimer(10)" class="bg-gray-800 hover:bg-gray-700 py-3 rounded-lg text-sm transition-colors">10m</button>
                            <button onclick="setQuickTimer(15)" class="bg-gray-800 hover:bg-gray-700 py-3 rounded-lg text-sm transition-colors">15m</button>
                            <button onclick="setQuickTimer(20)" class="bg-gray-800 hover:bg-gray-700 py-3 rounded-lg text-sm transition-colors">20m</button>
                            <button onclick="setQuickTimer(30)" class="bg-gray-800 hover:bg-gray-700 py-3 rounded-lg text-sm transition-colors">30m</button>
                            <button onclick="setQuickTimer(60)" class="bg-gray-800 hover:bg-gray-700 py-3 rounded-lg text-sm transition-colors">1h</button>
                        </div>
                        
                        <!-- Timer Controls -->
                        <div class="flex justify-center space-x-4">
                            <button id="timerReset" onclick="resetTimer()" class="bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded-full font-medium transition-colors">
                                Reset
                            </button>
                            <button id="timerStart" onclick="toggleTimer()" class="bg-orange-500 hover:bg-orange-600 px-6 py-3 rounded-full font-medium transition-colors">
                                Start
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-lg w-full max-w-md slide-up modal-content">
            <div class="p-4 border-b border-gray-700 modal-header">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold">Settings</h3>
                    <button onclick="closeSettings()" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Time Format</label>
                    <select id="timeFormat" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-orange-500 focus:outline-none">
                        <option value="12">12 Hour</option>
                        <option value="24">24 Hour</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Theme</label>
                    <select id="themeSelect" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-orange-500 focus:outline-none">
                        <option value="dark">Dark</option>
                        <option value="light">Light</option>
                        <option value="auto">Auto</option>
                    </select>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium">Notifications</span>
                    <button id="notificationToggle" onclick="toggleNotifications()" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-600 transition-colors focus:outline-none">
                        <span class="sr-only">Enable notifications</span>
                        <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- World Clock Modal -->
    <div id="worldClockModal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-lg w-full max-w-md slide-up modal-content">
            <div class="p-4 border-b border-gray-700 modal-header">
                <h3 class="text-lg font-semibold">Add World Clock</h3>
            </div>
            <div class="p-4">
                <input type="text" id="citySearch" placeholder="Search city..." class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 mb-4 text-white focus:border-orange-500 focus:outline-none">
                <div id="cityResults" class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                    <!-- Search results will appear here -->
                </div>
                <div class="flex justify-end space-x-2 mt-4 modal-footer">
                    <button onclick="closeWorldClockModal()" class="px-4 py-2 text-gray-400 hover:text-white rounded-full transition-colors">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alarm Modal (for adding/editing alarms) -->
    <div id="alarmModal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-lg w-full max-w-md slide-up modal-content">
            <div class="p-4 border-b border-gray-700 modal-header">
                <h3 id="alarmModalTitle" class="text-lg font-semibold">Add Alarm</h3>
            </div>
            <div class="p-4">
                <div class="mb-4">
                    <label for="alarmTime" class="block text-sm font-medium mb-2">Time</label>
                    <input type="time" id="alarmTime" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-xl text-white focus:border-orange-500 focus:outline-none">
                </div>
                <div class="mb-4">
                    <label for="alarmLabel" class="block text-sm font-medium mb-2">Label (Optional)</label>
                    <input type="text" id="alarmLabel" placeholder="e.g., Wake up, Meeting" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-orange-500 focus:outline-none">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Repeat</label>
                    <div class="flex flex-wrap gap-2">
                        <button class="day-btn bg-gray-700 px-3 py-2 rounded-full text-xs hover:bg-gray-600 transition-colors" data-day="Sunday">Sun</button>
                        <button class="day-btn bg-gray-700 px-3 py-2 rounded-full text-xs hover:bg-gray-600 transition-colors" data-day="Monday">Mon</button>
                        <button class="day-btn bg-gray-700 px-3 py-2 rounded-full text-xs hover:bg-gray-600 transition-colors" data-day="Tuesday">Tue</button>
                        <button class="day-btn bg-gray-700 px-3 py-2 rounded-full text-xs hover:bg-gray-600 transition-colors" data-day="Wednesday">Wed</button>
                        <button class="day-btn bg-gray-700 px-3 py-2 rounded-full text-xs hover:bg-gray-600 transition-colors" data-day="Thursday">Thu</button>
                        <button class="day-btn bg-gray-700 px-3 py-2 rounded-full text-xs hover:bg-gray-600 transition-colors" data-day="Friday">Fri</button>
                        <button class="day-btn bg-gray-700 px-3 py-2 rounded-full text-xs hover:bg-gray-600 transition-colors" data-day="Saturday">Sat</button>
                    </div>
                </div>
                <div class="flex justify-end space-x-2 mt-4 modal-footer">
                    <button onclick="closeAlarmModal()" class="px-4 py-2 text-gray-400 hover:text-white rounded-full transition-colors">Cancel</button>
                    <button id="saveAlarmBtn" onclick="saveAlarm()" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded-full font-medium transition-colors">Save Alarm</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables to store the app's state
        let currentTab = 'clock'; // Currently active tab: 'clock', 'alarm', 'stopwatch', 'timer'
        let clockFace = 'digital'; // Current clock display style: 'digital', 'analog', 'minimal'
        let stopwatchRunning = false; // Flag for stopwatch state
        let stopwatchTime = 0; // Stopwatch elapsed time in milliseconds
        let stopwatchInterval = null; // Interval ID for stopwatch updates
        let lapCount = 0; // Counter for stopwatch laps
        let timerRunning = false; // Flag for timer state
        let timerTime = 0; // Timer remaining time in seconds
        let timerInterval = null; // Interval ID for timer updates
        let timeFormat = 24; // Time display format: 12 or 24 hours
        let theme = 'dark'; // Current app theme: 'dark', 'light', 'auto'
        let notificationsEnabled = false; // Flag for notification permission status
        let alarms = []; // Array to store alarm objects
        let worldClocks = [ // Default world clocks
            { city: 'New York', timezone: 'America/New_York' },
            { city: 'London', timezone: 'Europe/London' },
            { city: 'Tokyo', timezone: 'Asia/Tokyo' },
            { city: 'Sydney', timezone: 'Australia/Sydney' }
        ];
        let editingAlarmId = null; // Stores the ID of the alarm currently being edited

        // Predefined list of popular cities for world clock functionality
        const popularCities = [
            { city: 'New York', timezone: 'America/New_York', country: 'USA' },
            { city: 'Los Angeles', timezone: 'America/Los_Angeles', country: 'USA' },
            { city: 'London', timezone: 'Europe/London', country: 'UK' },
            { city: 'Paris', timezone: 'Europe/Paris', country: 'France' },
            { city: 'Tokyo', timezone: 'Asia/Tokyo', country: 'Japan' },
            { city: 'Hong Kong', timezone: 'Asia/Hong_Kong', country: 'Hong Kong' },
            { city: 'Sydney', timezone: 'Australia/Sydney', country: 'Australia' },
            { city: 'Dubai', timezone: 'Asia/Dubai', country: 'UAE' },
            { city: 'Singapore', timezone: 'Asia/Singapore', country: 'Singapore' },
            { city: 'Beijing', timezone: 'Asia/Shanghai', country: 'China' },
            { city: 'Moscow', timezone: 'Europe/Moscow', country: 'Russia' },
            { city: 'Mumbai', timezone: 'Asia/Kolkata', country: 'India' },
            { city: 'Berlin', timezone: 'Europe/Berlin', country: 'Germany' },
            { city: 'Rome', timezone: 'Europe/Rome', country: 'Italy' },
            { city: 'Cairo', timezone: 'Africa/Cairo', country: 'Egypt' },
            { city: 'Cape Town', timezone: 'Africa/Johannesburg', country: 'South Africa' },
            { city: 'Mexico City', timezone: 'America/Mexico_City', country: 'Mexico' },
            { city: 'Rio de Janeiro', timezone: 'America/Sao_Paulo', country: 'Brazil' },
            { city: 'Buenos Aires', timezone: 'America/Argentina/Buenos_Aires', country: 'Argentina' }
        ];

        // --- Utility Functions ---

        /**
         * Formats a Date object into a time string based on global timeFormat setting.
         * @param {Date} date - The Date object to format.
         * @param {Object} options - Optional formatting options for toLocaleTimeString.
         * @returns {string} Formatted time string.
         */
        function formatTime(date, options = {}) {
            const defaultOptions = {
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit',
                hour12: timeFormat === 12, // Use global timeFormat setting
                ...options
            };
            return date.toLocaleTimeString('en-US', defaultOptions);
        }

        /**
         * Formats a Date object into a date string.
         * @param {Date} date - The Date object to format.
         * @returns {string} Formatted date string.
         */
        function formatDate(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        /**
         * Displays a custom message box (toast) instead of browser alerts.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message ('info', 'success', 'error').
         */
        function showMessageBox(message, type = 'info') {
            const messageBox = document.createElement('div');
            messageBox.className = `fixed bottom-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-white shadow-lg text-sm z-50 fade-in
                                    ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-gray-800'}`;
            messageBox.textContent = message;
            document.body.appendChild(messageBox);
            // Automatically remove the message after a delay
            setTimeout(() => {
                messageBox.classList.add('opacity-0'); // Start fade out
                messageBox.addEventListener('transitionend', () => messageBox.remove()); // Remove after transition
            }, 3000); // Display for 3 seconds
        }

        // --- Local Storage Management ---

        /**
         * Loads user settings, alarms, and world clocks from localStorage on app start.
         */
        function loadSettings() {
            timeFormat = parseInt(localStorage.getItem('miui-clock-timeFormat') || '24');
            theme = localStorage.getItem('miui-clock-theme') || 'dark';
            notificationsEnabled = localStorage.getItem('miui-clock-notifications') === 'true';
            
            // Parse alarms from stored JSON string
            const savedAlarms = localStorage.getItem('miui-clock-alarms');
            if (savedAlarms) {
                alarms = JSON.parse(savedAlarms);
            }
            
            // Parse world clocks from stored JSON string
            const savedWorldClocks = localStorage.getItem('miui-clock-worldClocks');
            if (savedWorldClocks) {
                worldClocks = JSON.parse(savedWorldClocks);
            }
            
            clockFace = localStorage.getItem('miui-clock-clockFace') || 'digital'; // Load preferred clock face

            applyTheme(theme); // Apply the loaded theme
            // Update settings modal UI to reflect loaded settings
            document.getElementById('timeFormat').value = timeFormat;
            document.getElementById('themeSelect').value = theme;
            updateNotificationToggleUI(); // Update notification toggle switch visual state
        }

        /**
         * Saves current user settings, alarms, and world clocks to localStorage.
         */
        function saveSettings() {
            localStorage.setItem('miui-clock-timeFormat', timeFormat.toString());
            localStorage.setItem('miui-clock-theme', theme);
            localStorage.setItem('miui-clock-notifications', notificationsEnabled.toString());
            localStorage.setItem('miui-clock-alarms', JSON.stringify(alarms)); // Store alarms as JSON string
            localStorage.setItem('miui-clock-worldClocks', JSON.stringify(worldClocks)); // Store world clocks as JSON string
            localStorage.setItem('miui-clock-clockFace', clockFace);
        }

        // --- Theme Management ---

        /**
         * Applies the selected theme (dark, light, or auto) to the entire application.
         * Dynamically adds/removes Tailwind CSS classes for various elements.
         * @param {string} selectedTheme - The theme to apply.
         */
        function applyTheme(selectedTheme) {
            const body = document.body;
            // Remove existing body theme classes and apply new ones
            body.classList.remove('bg-black', 'text-white', 'bg-white', 'text-black');
            if (selectedTheme === 'dark') {
                body.classList.add('bg-black', 'text-white');
                document.getElementById('themeIcon').classList.replace('fa-sun', 'fa-moon'); // Change theme icon
            } else if (selectedTheme === 'light') {
                body.classList.add('bg-white', 'text-black');
                document.getElementById('themeIcon').classList.replace('fa-moon', 'fa-sun'); // Change theme icon
            } else if (selectedTheme === 'auto') {
                // Check user's system preference for auto theme
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    body.classList.add('bg-black', 'text-white');
                    document.getElementById('themeIcon').classList.replace('fa-sun', 'fa-moon');
                } else {
                    body.classList.add('bg-white', 'text-black');
                    document.getElementById('themeIcon').classList.replace('fa-moon', 'fa-sun');
                }
            }

            // Define elements and their theme-specific classes
            const elementsToTheme = [
                { selector: 'header', dark: ['from-gray-900', 'to-black', 'text-white'], light: ['from-gray-200', 'to-gray-100', 'text-black'] },
                { selector: 'nav', dark: ['bg-gray-900'], light: ['bg-gray-100'] },
                { selector: '#settingsModal .modal-content', dark: ['bg-gray-900', 'text-white', 'border-gray-700'], light: ['bg-white', 'text-black', 'border-gray-300'] },
                { selector: '#worldClockModal .modal-content', dark: ['bg-gray-900', 'text-white', 'border-gray-700'], light: ['bg-white', 'text-black', 'border-gray-300'] },
                { selector: '#alarmModal .modal-content', dark: ['bg-gray-900', 'text-white', 'border-gray-700'], light: ['bg-white', 'text-black', 'border-gray-300'] }
            ];

            // Apply theme classes to static elements
            elementsToTheme.forEach(item => {
                const el = document.querySelector(item.selector);
                if (el) {
                    if (selectedTheme === 'light') {
                        item.dark.forEach(c => el.classList.remove(c));
                        item.light.forEach(c => el.classList.add(c));
                    } else {
                        item.light.forEach(c => el.classList.remove(c));
                        item.dark.forEach(c => el.classList.add(c));
                    }
                }
            });

            // Specific styling for tab buttons in navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-gray-300', 'hover:text-white', 'text-gray-700', 'hover:text-black');
                if (selectedTheme === 'light') {
                    btn.classList.add('text-gray-700', 'hover:text-black');
                } else {
                    btn.classList.add('text-gray-300', 'hover:text-white');
                }
            });
            // Adjust active tab button color
            const activeBtn = document.querySelector(`.tab-btn.active`);
            if (activeBtn) {
                if (selectedTheme === 'light') {
                    activeBtn.classList.remove('text-gray-700', 'text-gray-300');
                    activeBtn.classList.add('text-black'); 
                } else {
                    activeBtn.classList.remove('text-gray-700', 'text-black');
                    activeBtn.classList.add('text-white'); 
                }
            }

            // Adjust colors for inputs and general buttons within modals and content
            document.querySelectorAll('input, select').forEach(el => {
                el.classList.toggle('bg-gray-800', selectedTheme !== 'light');
                el.classList.toggle('bg-gray-100', selectedTheme === 'light');
                el.classList.toggle('border-gray-700', selectedTheme !== 'light');
                el.classList.toggle('border-gray-300', selectedTheme === 'light');
                el.classList.toggle('text-white', selectedTheme !== 'light');
                el.classList.toggle('text-black', selectedTheme === 'light');
            });
            
            // Adjust colors for general gray-background buttons
            document.querySelectorAll('button:not(.bg-orange-500):not(.bg-green-500):not(.bg-blue-500):not(.bg-purple-500)').forEach(el => {
                if (el.id === 'notificationToggle') return; // Handled separately
                if (el.classList.contains('day-btn') && el.classList.contains('bg-orange-500')) return; // Active day buttons
                
                el.classList.toggle('bg-gray-800', selectedTheme !== 'light');
                el.classList.toggle('bg-gray-100', selectedTheme === 'light');
                el.classList.toggle('text-white', selectedTheme !== 'light');
                el.classList.toggle('text-black', selectedTheme === 'light');
                el.classList.toggle('hover:bg-gray-700', selectedTheme !== 'light');
                el.classList.toggle('hover:bg-gray-200', selectedTheme === 'light');
            });

            // Special case for clock face buttons
            document.querySelectorAll('.clock-face-btn').forEach(btn => {
                if (btn.classList.contains('active')) { // Active button gets orange theme
                    btn.classList.remove('bg-gray-800', 'bg-gray-100', 'text-gray-400', 'text-gray-600');
                    btn.classList.add('bg-orange-500', 'text-white');
                } else { // Inactive buttons adapt to general theme
                    btn.classList.remove('bg-orange-500', 'text-white');
                    if (theme === 'light') {
                        btn.classList.add('bg-gray-100', 'text-gray-600');
                        btn.classList.remove('bg-gray-800', 'text-gray-400');
                    } else {
                        btn.classList.add('bg-gray-800', 'text-gray-400');
                        btn.classList.remove('bg-gray-100', 'text-gray-600');
                    }
                }
            });

            // Adjust text colors (e.g., for disabled text or secondary information)
            document.querySelectorAll('.text-gray-300').forEach(el => {
                el.classList.toggle('text-gray-300', selectedTheme !== 'light');
                el.classList.toggle('text-gray-700', selectedTheme === 'light');
            });
            document.querySelectorAll('.text-gray-400').forEach(el => {
                el.classList.toggle('text-gray-400', selectedTheme !== 'light');
                el.classList.toggle('text-gray-600', selectedTheme === 'light');
            });
            document.querySelectorAll('.text-gray-500').forEach(el => {
                el.classList.toggle('text-gray-500', selectedTheme !== 'light');
                el.classList.toggle('text-gray-700', selectedTheme === 'light');
            });

            // Re-render dynamic components to apply proper theme classes
            renderAlarms();
            updateWorldClocks();
        }

        /**
         * Toggles the theme between dark, light, and auto.
         */
        function toggleTheme() {
            if (theme === 'dark') {
                theme = 'light';
            } else if (theme === 'light') {
                theme = 'auto';
            } else { // current theme is 'auto'
                theme = 'dark';
            }
            document.getElementById('themeSelect').value = theme; // Update settings modal dropdown
            applyTheme(theme); // Apply the new theme
            saveSettings(); // Save the theme preference
        }

        // --- Clock Tab Functions ---

        /**
         * Updates the digital and analog clock displays, date, and timezone.
         * This function runs every second.
         */
        function updateTime() {
            const now = new Date();
            const digitalTimeElement = document.getElementById('digitalTime');
            const digitalDateElement = document.getElementById('digitalDate');
            const digitalTimezoneElement = document.getElementById('digitalTimezone');

            // Update Digital Clock
            const options = {
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit',
                hour12: timeFormat === 12 // Use user's preferred time format
            };
            digitalTimeElement.textContent = now.toLocaleTimeString('en-US', options);
            digitalDateElement.textContent = formatDate(now);
            
            // Calculate and display timezone offset
            const offsetMinutes = now.getTimezoneOffset();
            const offsetHours = Math.floor(Math.abs(offsetMinutes) / 60);
            const offsetRemainingMinutes = Math.abs(offsetMinutes) % 60;
            const sign = offsetMinutes > 0 ? '-' : '+'; // UTC offset is inverse of timezone offset
            digitalTimezoneElement.textContent = `UTC${sign}${String(offsetHours).padStart(2, '0')}:${String(offsetRemainingMinutes).padStart(2, '0')}`;

            // Update Analog Clock Hands
            const hourHand = document.getElementById('hourHand');
            const minuteHand = document.getElementById('minuteHand');
            const secondHand = document.getElementById('secondHand');

            const seconds = now.getSeconds();
            const minutes = now.getMinutes();
            const hours = now.getHours();

            // Calculate rotation angles (0 degrees at 12 o'clock, clockwise positive)
            const secondAngle = seconds * 6; // 360 degrees / 60 seconds = 6 degrees/second
            const minuteAngle = (minutes * 6) + (seconds * 0.1); // 6 degrees/minute + 0.1 degrees for second progress
            const hourAngle = ((hours % 12) * 30) + (minutes * 0.5) + (seconds * (0.5/60)); // 30 degrees/hour + 0.5 degrees/minute + tiny bit for seconds

            // Apply rotation using CSS transform for smooth animation
            hourHand.style.transform = `rotate(${hourAngle}deg)`;
            minuteHand.style.transform = `rotate(${minuteAngle}deg)`;
            secondHand.style.transform = `rotate(${secondAngle}deg)`;

            updateWorldClocks(); // Also update world clocks every second
        }

        /**
         * Dynamically creates the hour markers on the analog clock face.
         */
        function createHourMarkers() {
            const hourMarkersGroup = document.getElementById('hourMarkers');
            hourMarkersGroup.innerHTML = ''; // Clear any existing markers

            const radius = 95; // Radius from center to outer edge of clock face
            const innerRadius = 85; // Radius to inner edge of hour markers

            for (let i = 0; i < 12; i++) {
                // Angle for each hour mark (0 at 12 o'clock, increasing clockwise)
                const angle = (i * 30); // 360 degrees / 12 hours = 30 degrees per hour
                // Convert to radians and adjust for SVG coordinate system (0 deg is +X axis)
                const radians = (angle - 90) * Math.PI / 180; 

                // Calculate start and end points of the marker line
                const x1 = 100 + radius * Math.cos(radians);
                const y1 = 100 + radius * Math.sin(radians);
                const x2 = 100 + innerRadius * Math.cos(radians);
                const y2 = 100 + innerRadius * Math.sin(radians);

                const marker = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                marker.setAttribute('x1', x1);
                marker.setAttribute('y1', y1);
                marker.setAttribute('x2', x2);
                marker.setAttribute('y2', y2);
                marker.setAttribute('stroke', 'rgba(255,255,255,0.4)'); // White with transparency
                marker.setAttribute('stroke-width', '2');
                marker.setAttribute('stroke-linecap', 'round');
                hourMarkersGroup.appendChild(marker);
            }
        }

        /**
         * Adjusts the visibility of digital/analog clock components based on the selected clock face.
         */
        function initializeClockDisplay() {
            const digitalClockSection = document.getElementById('mainClock');
            const analogClockSection = document.querySelector('#clockTab .flex.justify-center'); // Parent of SVG
            const analogClockSvg = document.querySelector('#clockTab .relative svg'); // The SVG itself

            // Reset visibility for all components
            digitalClockSection.classList.add('hidden');
            analogClockSection.classList.add('hidden');
            analogClockSvg.classList.add('hidden'); // Hide the analog SVG by default for minimal

            if (clockFace === 'digital') {
                digitalClockSection.classList.remove('hidden');
            } else if (clockFace === 'analog') {
                digitalClockSection.classList.remove('hidden'); // Digital time always visible for analog
                analogClockSection.classList.remove('hidden');
                analogClockSvg.classList.remove('hidden'); // Ensure analog SVG is visible
            } else if (clockFace === 'minimal') {
                digitalClockSection.classList.remove('hidden'); // Only digital time for minimal
            }

            // Update active state of clock face selection buttons
            document.querySelectorAll('.clock-face-btn').forEach(btn => {
                if (btn.dataset.face === clockFace) {
                    btn.classList.add('active');
                    btn.classList.add('bg-orange-500', 'text-white');
                    btn.classList.remove('bg-gray-800', 'bg-gray-100', 'text-gray-400', 'text-gray-600');
                } else {
                    btn.classList.remove('active');
                    btn.classList.remove('bg-orange-500', 'text-white');
                    // Reapply theme-specific inactive button styles
                    if (theme === 'light') {
                        btn.classList.add('bg-gray-100', 'text-gray-600');
                        btn.classList.remove('bg-gray-800', 'text-gray-400');
                    } else {
                        btn.classList.add('bg-gray-800', 'text-gray-400');
                        btn.classList.remove('bg-gray-100', 'text-gray-600');
                    }
                }
            });
        }

        /**
         * Changes the currently displayed clock face (digital, analog, minimal).
         * @param {string} face - The name of the clock face to switch to.
         */
        function changeClockFace(face) {
            clockFace = face;
            initializeClockDisplay(); // Re-render clock display based on new face
            saveSettings(); // Save the preference
        }

        /**
         * Updates the header logo and its background gradient based on the current time of day.
         */
        function updateDynamicLogo() {
            const now = new Date();
            const hours = now.getHours();
            const logoDiv = document.getElementById('dynamicLogo');
            const logoIcon = logoDiv.querySelector('i');

            // Remove all existing gradient and icon classes
            logoDiv.classList.remove('gradient-orange', 'gradient-blue', 'gradient-purple', 'bg-orange-500');
            logoIcon.classList.remove('fa-clock', 'fa-sun', 'fa-moon', 'fa-cloud');

            // Apply new classes based on time of day
            if (hours >= 6 && hours < 12) { // Morning (6 AM - 11:59 AM)
                logoDiv.classList.add('gradient-orange'); // Sunrise-like color
                logoIcon.classList.add('fa-sun'); // Sun icon
            } else if (hours >= 12 && hours < 18) { // Afternoon (12 PM - 5:59 PM)
                logoDiv.classList.add('gradient-blue'); // Daytime sky color
                logoIcon.classList.add('fa-sun'); // Sun icon
            } else if (hours >= 18 && hours < 22) { // Evening (6 PM - 9:59 PM)
                logoDiv.classList.add('gradient-purple'); // Sunset/dusk color
                logoIcon.classList.add('fa-cloud'); // Cloud/dusk icon
            } else { // Night (10 PM - 5:59 AM)
                logoDiv.classList.add('gradient-orange'); // Darker, subtle orange for night
                logoIcon.classList.add('fa-moon'); // Moon icon
            }

            // If light theme is active, use a solid color instead of gradient for simplicity
            if (theme === 'light') {
                logoDiv.classList.remove('gradient-orange', 'gradient-blue', 'gradient-purple');
                logoDiv.classList.add('bg-orange-500'); // Simple solid orange
            }
        }

        /**
         * Attempts to get and display the user's current location using Geolocation API.
         */
        function getCurrentLocation() {
            const currentLocationElement = document.getElementById('currentLocation');
            if (navigator.geolocation) {
                // Options for geolocation: enable high accuracy, set a timeout
                const geoOptions = {
                    enableHighAccuracy: true,
                    timeout: 5000, // 5 seconds
                    maximumAge: 0 // No cached position
                };

                navigator.geolocation.getCurrentPosition(async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    try {
                        // Use OpenStreetMap Nominatim for reverse geocoding to get city/country
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10`);
                        const data = await response.json();
                        if (data.address) {
                            const city = data.address.city || data.address.town || data.address.village || data.address.county;
                            const country = data.address.country;
                            if (city && country) {
                                currentLocationElement.textContent = `${city}, ${country}`;
                            } else if (country) {
                                currentLocationElement.textContent = country; // Fallback to just country
                            } else {
                                currentLocationElement.textContent = 'Unknown Location';
                            }
                        } else {
                            currentLocationElement.textContent = 'Unknown Location';
                        }
                    } catch (error) {
                        console.error('Error fetching location data from Nominatim:', error);
                        currentLocationElement.textContent = 'Location data unavailable';
                    }
                }, (error) => {
                    // Log the error object directly with its code and message properties
                    console.error('Geolocation error:', error.code, error.message, error); 
                    let errorMessage = 'Location access denied';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied. Please enable it in your browser settings.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information is unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'The request to get user location timed out.';
                            break;
                        case error.UNKNOWN_ERROR:
                            errorMessage = 'An unknown error occurred while trying to get location.';
                            break;
                        default:
                            errorMessage = `Geolocation error: ${error.message || 'Unknown error code: ' + error.code}.`;
                            break;
                    }
                    currentLocationElement.textContent = errorMessage;
                }, geoOptions); // Pass the options object here
            } else {
                currentLocationElement.textContent = 'Geolocation not supported by this browser.'; // Browser doesn't support GeoLocation
            }
        }

        // --- World Clock Functions ---

        /**
         * Renders the list of world clocks in the 'Clock' tab.
         * Updates their times dynamically.
         */
        function updateWorldClocks() {
            const worldClocksContainer = document.getElementById('worldClocks');
            worldClocksContainer.innerHTML = ''; // Clear existing entries

            if (worldClocks.length === 0) {
                // Display a message if no world clocks are added
                const textColor = theme === 'light' ? 'text-gray-700' : 'text-gray-500';
                worldClocksContainer.innerHTML = `<p class="text-center ${textColor} py-8">No world clocks added yet. Click "+" to add one!</p>`;
                return;
            }

            worldClocks.forEach((wc) => {
                try {
                    const now = new Date();
                    const dateOptions = { weekday: 'short', month: 'short', day: 'numeric' };
                    const timeOptions = { hour: 'numeric', minute: '2-digit', hour12: timeFormat === 12, timeZone: wc.timezone };

                    // Format time and date for the specific timezone
                    const timeInZone = now.toLocaleTimeString('en-US', timeOptions);
                    const dateInZone = now.toLocaleDateString('en-US', dateOptions);

                    // Calculate time difference relative to local time
                    const localTime = new Date();
                    // Get hours in specific timezone and local timezone, then calculate difference
                    const targetHours = new Date(now.toLocaleString('en-US', { timeZone: wc.timezone })).getHours();
                    const localHours = localTime.getHours();
                    let diffHours = (targetHours - localHours + 24) % 24; // Ensure positive difference
                    
                    let timeDifference = '';
                    if (diffHours === 0) {
                        timeDifference = 'Same time';
                    } else if (diffHours > 12) {
                        timeDifference = `${24 - diffHours} hours behind`; // If diff is >12, it's actually behind
                    } else if (diffHours < 12) {
                        timeDifference = `${diffHours} hours ahead`;
                    } else { // diffHours === 12
                        timeDifference = '12 hours difference';
                    }

                    // Determine theme-specific classes for the item
                    const itemBgClass = theme === 'light' ? 'bg-gray-100 text-black border-gray-300' : 'bg-gray-800 text-white border-gray-700';
                    const subTextColor = theme === 'light' ? 'text-gray-600' : 'text-gray-400';
                    const timeDiffColor = theme === 'light' ? 'text-gray-700' : 'text-gray-500';
                    const trashIconColor = theme === 'light' ? 'text-gray-600 hover:text-red-500' : 'text-gray-400 hover:text-red-500';


                    const worldClockItem = document.createElement('div');
                    worldClockItem.className = `world-clock-item flex items-center justify-between p-4 rounded-xl glass shadow-xl fade-in ${itemBgClass}`;
                    worldClockItem.innerHTML = `
                        <div>
                            <h4 class="text-2xl font-semibold">${timeInZone}</h4>
                            <p class="${subTextColor} text-sm">${dateInZone}</p>
                        </div>
                        <div class="text-right flex-1 ml-4">
                            <h4 class="text-lg font-medium">${wc.city}</h4>
                            <p class="${timeDiffColor} text-xs">${timeDifference}</p>
                        </div>
                        <button onclick="deleteWorldClock('${wc.timezone}')" class="${trashIconColor} transition-colors ml-4 p-2 rounded-full hover:bg-red-800/20">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    worldClocksContainer.appendChild(worldClockItem);
                } catch (e) {
                    console.error(`Error displaying world clock for ${wc.city}:`, e);
                    // Display an error state for invalid timezones
                    const itemBgClass = theme === 'light' ? 'bg-red-100 text-red-800 border-red-300' : 'bg-red-900 text-red-300 border-red-700';
                    const trashIconColor = theme === 'light' ? 'text-red-600 hover:text-red-800' : 'text-red-300 hover:text-red-100';

                    const worldClockItem = document.createElement('div');
                    worldClockItem.className = `world-clock-item flex items-center justify-between p-4 rounded-xl glass shadow-xl fade-in ${itemBgClass}`;
                    worldClockItem.innerHTML = `
                        <div>
                            <h4 class="text-xl font-semibold">Invalid Timezone</h4>
                            <p class="text-sm">Error: ${wc.city}</p>
                        </div>
                        <div class="text-right flex-1 ml-4">
                            <h4 class="text-lg font-medium">Please remove</h4>
                            <p class="text-xs">Timezone: ${wc.timezone}</p>
                        </div>
                        <button onclick="deleteWorldClock('${wc.timezone}')" class="${trashIconColor} transition-colors ml-4 p-2 rounded-full hover:bg-red-800/20">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    worldClocksContainer.appendChild(worldClockItem);
                }
            });
        }

        /**
         * Opens the modal for adding a new world clock.
         * Pre-populates search results with popular cities.
         */
        function addWorldClock() {
            document.getElementById('worldClockModal').classList.remove('hidden');
            document.getElementById('citySearch').value = ''; // Clear previous search
            renderCityResults(popularCities); // Show popular cities by default
        }

        /**
         * Closes the world clock addition modal.
         */
        function closeWorldClockModal() {
            document.getElementById('worldClockModal').classList.add('hidden');
        }

        /**
         * Event listener for city search input. Filters popular cities based on input.
         */
        document.getElementById('citySearch').addEventListener('input', (event) => {
            const searchTerm = event.target.value.toLowerCase();
            const filteredCities = popularCities.filter(city =>
                city.city.toLowerCase().includes(searchTerm) || city.country.toLowerCase().includes(searchTerm)
            );
            renderCityResults(filteredCities);
        });

        /**
         * Renders the list of cities in the world clock search results modal.
         * @param {Array} cities - An array of city objects to display.
         */
        function renderCityResults(cities) {
            const cityResultsContainer = document.getElementById('cityResults');
            cityResultsContainer.innerHTML = ''; // Clear previous results

            if (cities.length === 0) {
                const textColor = theme === 'light' ? 'text-gray-700' : 'text-gray-500';
                cityResultsContainer.innerHTML = `<p class="text-center ${textColor} py-4">No results found.</p>`;
                return;
            }

            cities.forEach(city => {
                const cityItem = document.createElement('button');
                // Apply theme-specific hover and text colors
                const btnClasses = theme === 'light' ? 'hover:bg-gray-200 text-black' : 'hover:bg-gray-700 text-white';
                const subTextColor = theme === 'light' ? 'text-gray-600' : 'text-gray-400';

                cityItem.className = `w-full text-left p-3 rounded-lg transition-colors ${btnClasses}`;
                cityItem.innerHTML = `
                    <span class="font-medium">${city.city}</span>
                    <span class="${subTextColor} text-sm"> (${city.country})</span>
                `;
                cityItem.onclick = () => addSelectedWorldClock(city.city, city.timezone);
                cityResultsContainer.appendChild(cityItem);
            });
        }

        /**
         * Adds a selected city to the world clocks list.
         * @param {string} city - The name of the city.
         * @param {string} timezone - The IANA timezone identifier for the city.
         */
        function addSelectedWorldClock(city, timezone) {
            // Prevent adding duplicate cities based on timezone
            if (worldClocks.some(wc => wc.timezone === timezone)) {
                showMessageBox('This city is already added.', 'info');
                return;
            }
            worldClocks.push({ city, timezone });
            saveSettings(); // Save updated list
            updateWorldClocks(); // Re-render world clocks
            closeWorldClockModal(); // Close the modal
            showMessageBox(`${city} added to world clocks.`, 'success');
        }

        /**
         * Deletes a world clock entry from the list.
         * @param {string} timezoneToDelete - The timezone of the world clock to delete.
         */
        function deleteWorldClock(timezoneToDelete) {
            worldClocks = worldClocks.filter(wc => wc.timezone !== timezoneToDelete);
            saveSettings(); // Save updated list
            updateWorldClocks(); // Re-render world clocks
            showMessageBox('World clock removed.', 'success');
        }

        // --- Notification Functions ---

        /**
         * Checks the current notification permission status and updates UI/settings accordingly.
         */
        function checkNotificationPermission() {
            // Check if browser supports notifications
            if (!("Notification" in window)) {
                console.warn("This browser does not support desktop notification.");
                document.getElementById('notificationBanner').classList.add('hidden'); // Hide banner if not supported
                notificationsEnabled = false; // Ensure setting is false
                saveSettings();
            } else if (Notification.permission === "granted") {
                // If permission is already granted, hide the banner
                document.getElementById('notificationBanner').classList.add('hidden');
                notificationsEnabled = true;
                saveSettings();
            } else if (Notification.permission !== "denied") {
                // If permission is 'default' (not yet asked or not granted/denied), show the banner
                document.getElementById('notificationBanner').classList.remove('hidden');
            }
            updateNotificationToggleUI(); // Update the settings toggle switch
        }

        /**
         * Requests notification permission from the user.
         */
        function requestNotificationPermission() {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    notificationsEnabled = true;
                    document.getElementById('notificationBanner').classList.add('hidden'); // Hide banner on grant
                    showMessageBox('Notifications enabled!', 'success');
                } else {
                    notificationsEnabled = false;
                    showMessageBox('Notifications denied. Please enable them in your browser settings if you wish to receive them.', 'error');
                }
                saveSettings(); // Save the new permission status
                updateNotificationToggleUI(); // Update the settings toggle switch
            });
        }

        /**
         * Dismisses the notification permission banner from the UI.
         */
        function dismissNotificationBanner() {
            document.getElementById('notificationBanner').classList.add('hidden');
        }

        /**
         * Displays a browser notification (if permissions are granted).
         * Also shows a custom message box as a fallback/confirmation.
         * @param {string} title - The title of the notification.
         * @param {string} body - The body text of the notification.
         * @param {string} tag - An optional tag to group notifications.
         */
        function showNotification(title, body, tag = null) {
            if (notificationsEnabled && Notification.permission === "granted") {
                const options = {
                    body: body,
                    // Use a data URI for the icon (transparent SVG)
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNGRjY5MDAiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiLz4KPGxpbmUgeDE9IjEyIiB5MT0iMTIiIHgyPSIxMiIgeTI9IjYuNSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPGxpbmUgeDE9IjEyIiB5MT0iMTIiIHgyPSIxNi41IiB5Mj0iMTIuNSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+Cjwvc3ZnPg==', 
                    tag: tag || Date.now(), // Unique tag for consistent notifications
                    renotify: true // Allow new notifications to replace existing ones with the same tag
                };
                new Notification(title, options);
            } else {
                // Fallback to custom message box if notifications are not enabled/granted
                showMessageBox(`Notification: ${title} - ${body}`, 'info');
            }
        }

        // --- Alarm Tab Functions ---

        /**
         * Renders the list of configured alarms in the 'Alarm' tab.
         */
        function renderAlarms() {
            const alarmsList = document.getElementById('alarmsList');
            alarmsList.innerHTML = ''; // Clear existing alarms

            if (alarms.length === 0) {
                // Display a message if no alarms are set
                const textColor = theme === 'light' ? 'text-gray-700' : 'text-gray-500';
                alarmsList.innerHTML = `<p class="text-center ${textColor} py-8">No alarms set yet. Click "Add Alarm" to create one!</p>`;
                return;
            }

            alarms.forEach(alarm => {
                // Determine theme-specific classes for the alarm item
                const itemBgClass = theme === 'light' ? 'bg-gray-100 text-black border-gray-300' : 'bg-gray-800 text-white border-gray-700';
                const subTextColor = theme === 'light' ? 'text-gray-600' : 'text-gray-400';
                const dayTextColor = theme === 'light' ? 'text-gray-700' : 'text-gray-500';
                const iconColor = theme === 'light' ? 'text-gray-700 hover:bg-gray-200' : 'text-gray-400 hover:bg-gray-700';
                const deleteIconColor = theme === 'light' ? 'text-gray-700 hover:text-white hover:bg-red-500' : 'text-gray-400 hover:text-white hover:bg-red-500';

                const alarmItem = document.createElement('div');
                alarmItem.className = `flex items-center justify-between p-4 rounded-xl glass shadow-xl fade-in ${itemBgClass}`;
                alarmItem.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <span class="text-5xl font-light digital-font">${alarm.time}</span>
                            ${alarm.enabled ? '<span class="notification-dot absolute -top-1 -right-1 w-2 h-2 rounded-full bg-orange-500"></span>' : ''}
                        </div>
                        <div>
                            <p class="${subTextColor} text-sm">${alarm.label || 'Alarm'}</p>
                            <p class="${dayTextColor} text-xs">${alarm.repeat.length > 0 ? alarm.repeat.map(d => d.substring(0, 3)).join(', ') : 'Once'}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="toggleAlarm('${alarm.id}')" class="relative inline-flex h-6 w-11 items-center rounded-full ${alarm.enabled ? 'bg-orange-500' : 'bg-gray-600'} transition-colors focus:outline-none">
                            <span class="sr-only">Toggle Alarm</span>
                            <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${alarm.enabled ? 'translate-x-6' : 'translate-x-1'}"></span>
                        </button>
                        <button onclick="editAlarm('${alarm.id}')" class="p-2 rounded-full ${iconColor} transition-colors">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteAlarm('${alarm.id}')" class="p-2 rounded-full ${deleteIconColor} transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                alarmsList.appendChild(alarmItem);
            });
        }

        /**
         * Opens the alarm modal to add a new alarm. Resets the form.
         */
        function addAlarm() {
            editingAlarmId = null; // Clear editing state
            document.getElementById('alarmModalTitle').textContent = 'Add Alarm';
            document.getElementById('alarmTime').value = ''; // Clear time input
            document.getElementById('alarmLabel').value = ''; // Clear label input
            // Reset day selection buttons
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.classList.remove('bg-orange-500', 'text-white');
                if (theme === 'light') {
                    btn.classList.add('bg-gray-200', 'text-black');
                    btn.classList.remove('bg-gray-700');
                } else {
                    btn.classList.add('bg-gray-700');
                    btn.classList.remove('bg-gray-200', 'text-black');
                }
            });
            document.getElementById('alarmModal').classList.remove('hidden'); // Show the modal
        }

        /**
         * Opens the alarm modal to edit an existing alarm. Populates the form with alarm data.
         * @param {string} id - The unique ID of the alarm to edit.
         */
        function editAlarm(id) {
            editingAlarmId = id; // Set editing state
            const alarmToEdit = alarms.find(a => a.id === id);
            if (!alarmToEdit) {
                showMessageBox('Alarm not found.', 'error');
                return;
            }

            document.getElementById('alarmModalTitle').textContent = 'Edit Alarm';
            document.getElementById('alarmTime').value = alarmToEdit.time;
            document.getElementById('alarmLabel').value = alarmToEdit.label;

            // Set selected days based on existing alarm's repeat property
            document.querySelectorAll('.day-btn').forEach(btn => {
                const day = btn.dataset.day;
                if (alarmToEdit.repeat.includes(day)) {
                    btn.classList.add('bg-orange-500', 'text-white');
                    btn.classList.remove('bg-gray-700', 'bg-gray-200', 'text-black');
                } else {
                    btn.classList.remove('bg-orange-500', 'text-white');
                    if (theme === 'light') {
                        btn.classList.add('bg-gray-200', 'text-black');
                        btn.classList.remove('bg-gray-700');
                    } else {
                        btn.classList.add('bg-gray-700');
                        btn.classList.remove('bg-gray-200', 'text-black');
                    }
                }
            });
            document.getElementById('alarmModal').classList.remove('hidden'); // Show the modal
        }

        /**
         * Toggles the selection state of a day button in the alarm modal.
         */
        document.querySelectorAll('.day-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('bg-orange-500');
                btn.classList.toggle('text-white');
                // Adjust for theme-specific inactive state
                if (theme === 'light') {
                    btn.classList.toggle('bg-gray-200');
                    btn.classList.toggle('text-black');
                } else {
                    btn.classList.toggle('bg-gray-700');
                }
            });
        });

        /**
         * Closes the alarm addition/editing modal.
         */
        function closeAlarmModal() {
            document.getElementById('alarmModal').classList.add('hidden');
        }

        /**
         * Saves a new or updated alarm based on the modal form inputs.
         */
        function saveAlarm() {
            const alarmTime = document.getElementById('alarmTime').value;
            const alarmLabel = document.getElementById('alarmLabel').value;
            // Get selected days for repetition
            const selectedDays = Array.from(document.querySelectorAll('.day-btn.bg-orange-500')).map(btn => btn.dataset.day);

            if (!alarmTime) {
                showMessageBox('Please set a time for the alarm.', 'error');
                return;
            }

            if (editingAlarmId) {
                // If editing an existing alarm
                alarms = alarms.map(alarm => {
                    if (alarm.id === editingAlarmId) {
                        return {
                            ...alarm, // Keep existing properties (like enabled state)
                            time: alarmTime,
                            label: alarmLabel,
                            repeat: selectedDays,
                        };
                    }
                    return alarm;
                });
                showMessageBox('Alarm updated successfully!', 'success');
            } else {
                // If adding a new alarm
                const newAlarm = {
                    id: crypto.randomUUID(), // Generate a unique ID for the new alarm
                    time: alarmTime,
                    label: alarmLabel,
                    repeat: selectedDays,
                    enabled: true // New alarms are enabled by default
                };
                alarms.push(newAlarm);
                showMessageBox('Alarm added successfully!', 'success');
            }

            saveSettings(); // Save the updated alarms list
            renderAlarms(); // Re-render the alarm list in the UI
            closeAlarmModal(); // Close the modal
        }

        /**
         * Toggles the enabled/disabled state of an alarm.
         * @param {string} id - The unique ID of the alarm to toggle.
         */
        function toggleAlarm(id) {
            alarms = alarms.map(alarm => {
                if (alarm.id === id) {
                    return { ...alarm, enabled: !alarm.enabled }; // Flip enabled state
                }
                return alarm;
            });
            saveSettings(); // Save the updated alarm state
            renderAlarms(); // Re-render to show visual change
            showMessageBox(`Alarm ${alarms.find(a => a.id === id).enabled ? 'enabled' : 'disabled'}.`, 'info');
        }

        /**
         * Deletes an alarm from the list.
         * @param {string} id - The unique ID of the alarm to delete.
         */
        function deleteAlarm(id) {
            alarms = alarms.filter(alarm => alarm.id !== id); // Filter out the deleted alarm
            saveSettings(); // Save the updated list
            renderAlarms(); // Re-render the alarm list
            showMessageBox('Alarm deleted!', 'success');
        }

        /**
         * Periodically checks if any enabled alarms match the current time and triggers notifications.
         */
        function checkAlarms() {
            const now = new Date();
            const currentHour = String(now.getHours()).padStart(2, '0');
            const currentMinute = String(now.getMinutes()).padStart(2, '0');
            const currentTime = `${currentHour}:${currentMinute}`;
            const currentDay = now.toLocaleDateString('en-US', { weekday: 'long' });

            alarms.forEach(alarm => {
                // Check if alarm is enabled and its time matches current time
                if (alarm.enabled && alarm.time === currentTime) {
                    // Check repetition logic
                    if (alarm.repeat.length === 0) { // One-time alarm
                        showNotification('Alarm!', alarm.label || 'Time to wake up!');
                        alarm.enabled = false; // Disable one-time alarm after triggering
                    } else if (alarm.repeat.includes(currentDay)) { // Repeating alarm for the current day
                        showNotification('Alarm!', alarm.label || 'Time to wake up!');
                        // For repeating alarms, a more robust debounce/cooldown mechanism
                        // would be needed to prevent multiple notifications within the same minute.
                        // For this example, it will trigger once per minute it's active.
                    }
                }
            });
            renderAlarms(); // Update UI if any alarm was disabled
            saveSettings(); // Save any changes to alarm states (e.g., disabled one-time alarms)
        }

        // --- Stopwatch Tab Functions ---

        /**
         * Updates the stopwatch display with the current elapsed time.
         */
        function updateStopwatch() {
            const stopwatchTimeElement = document.getElementById('stopwatchTime');
            const minutes = Math.floor(stopwatchTime / 60000);
            const seconds = Math.floor((stopwatchTime % 60000) / 1000);
            const milliseconds = Math.floor((stopwatchTime % 1000) / 10); // Display in centiseconds

            stopwatchTimeElement.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}`;
        }

        /**
         * Starts or pauses the stopwatch.
         */
        function toggleStopwatch() {
            const startButton = document.getElementById('stopwatchStart');
            const lapButton = document.getElementById('stopwatchLap');

            if (!stopwatchRunning) {
                stopwatchRunning = true;
                startButton.textContent = 'Pause';
                startButton.classList.replace('bg-green-500', 'bg-orange-500'); // Change color to orange when running
                lapButton.disabled = false; // Enable lap button
                // Start interval to update stopwatch every 10 milliseconds
                stopwatchInterval = setInterval(() => {
                    stopwatchTime += 10; 
                    updateStopwatch();
                }, 10);
                showMessageBox('Stopwatch started!', 'info');
            } else {
                stopwatchRunning = false;
                startButton.textContent = 'Resume'; // Change text to resume when paused
                startButton.classList.replace('bg-orange-500', 'bg-green-500'); // Change color back to green when paused
                lapButton.disabled = true; // Disable lap button when paused
                clearInterval(stopwatchInterval); // Stop the interval
                showMessageBox('Stopwatch paused.', 'info');
            }
        }

        /**
         * Resets the stopwatch to zero.
         */
        function resetStopwatch() {
            clearInterval(stopwatchInterval); // Clear any running interval
            stopwatchRunning = false;
            stopwatchTime = 0;
            lapCount = 0;
            document.getElementById('stopwatchStart').textContent = 'Start';
            document.getElementById('stopwatchStart').classList.replace('bg-orange-500', 'bg-green-500'); // Reset button color
            document.getElementById('stopwatchLap').disabled = true; // Disable lap button
            document.getElementById('lapTimes').innerHTML = ''; // Clear lap times display
            updateStopwatch(); // Reset display to 00:00.00
            showMessageBox('Stopwatch reset.', 'success');
        }

        /**
         * Records a lap time for the stopwatch.
         */
        function lapStopwatch() {
            if (!stopwatchRunning) return; // Only record laps if stopwatch is running
            
            lapCount++;
            const lapTimeElement = document.createElement('p');
            const textColor = theme === 'light' ? 'text-gray-700' : 'text-gray-300';
            lapTimeElement.className = `${textColor} digital-font fade-in`; // Apply theme text color

            const minutes = Math.floor(stopwatchTime / 60000);
            const seconds = Math.floor((stopwatchTime % 60000) / 1000);
            const milliseconds = Math.floor((stopwatchTime % 1000) / 10);

            lapTimeElement.textContent = `Lap ${String(lapCount).padStart(2, '0')}: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}`;
            document.getElementById('lapTimes').prepend(lapTimeElement); // Add new lap to the top of the list
            showMessageBox(`Lap ${lapCount} recorded.`, 'info');
        }

        // --- Timer Tab Functions ---

        /**
         * Updates the timer display with the remaining time.
         */
        function updateTimerDisplay() {
            const timerDisplay = document.getElementById('timerDisplay');
            const hours = Math.floor(timerTime / 3600);
            const minutes = Math.floor((timerTime % 3600) / 60);
            const seconds = timerTime % 60;

            const formattedTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            timerDisplay.textContent = formattedTime;

            // Toggle visibility of input fields based on timer running state
            const timerInputDiv = document.getElementById('timerInput');
            if (timerRunning) {
                timerInputDiv.classList.add('hidden');
            } else {
                timerInputDiv.classList.remove('hidden');
                // Update input values when timer is not running
                document.getElementById('timerHours').value = hours;
                document.getElementById('timerMinutes').value = minutes;
                document.getElementById('timerSeconds').value = seconds;
            }
        }

        /**
         * Sets the timer to a predefined number of minutes.
         * @param {number} minutes - The number of minutes to set the timer for.
         */
        function setQuickTimer(minutes) {
            clearInterval(timerInterval); // Stop any running timer
            timerRunning = false;
            timerTime = minutes * 60; // Convert minutes to seconds
            document.getElementById('timerStart').textContent = 'Start';
            document.getElementById('timerStart').classList.replace('bg-purple-500', 'bg-orange-500');
            document.getElementById('timerStart').classList.replace('bg-green-500', 'bg-orange-500');
            updateTimerDisplay(); // Update display immediately
            showMessageBox(`Timer set to ${minutes} minutes.`, 'info');
        }

        /**
         * Starts or pauses the timer countdown.
         */
        function toggleTimer() {
            const timerStartButton = document.getElementById('timerStart');

            if (!timerRunning) {
                const hours = parseInt(document.getElementById('timerHours').value || 0);
                const minutes = parseInt(document.getElementById('timerMinutes').value || 0);
                const seconds = parseInt(document.getElementById('timerSeconds').value || 0);

                const totalSeconds = hours * 3600 + minutes * 60 + seconds;

                if (totalSeconds <= 0) {
                    showMessageBox('Please set a valid time for the timer.', 'error');
                    return;
                }

                timerTime = totalSeconds; // Set timer duration
                timerRunning = true;
                timerStartButton.textContent = 'Pause';
                timerStartButton.classList.replace('bg-orange-500', 'bg-purple-500'); // Change color to purple when running
                timerInterval = setInterval(startTimerCountdown, 1000); // Start countdown every second
                updateTimerDisplay(); // Update display immediately
                showMessageBox('Timer started!', 'success');
            } else {
                timerRunning = false;
                timerStartButton.textContent = 'Resume'; // Change text to resume when paused
                timerStartButton.classList.replace('bg-purple-500', 'bg-green-500'); // Change color to green when paused
                clearInterval(timerInterval); // Pause the interval
                showMessageBox('Timer paused.', 'info');
            }
        }

        /**
         * The core timer countdown logic. Decrements time and handles completion.
         */
        function startTimerCountdown() {
            if (timerTime > 0) {
                timerTime--;
                updateTimerDisplay();
            } else {
                clearInterval(timerInterval); // Stop the timer when it reaches zero
                timerRunning = false;
                document.getElementById('timerStart').textContent = 'Start'; // Reset button text
                document.getElementById('timerStart').classList.replace('bg-purple-500', 'bg-orange-500');
                document.getElementById('timerStart').classList.replace('bg-green-500', 'bg-orange-500');
                updateTimerDisplay(); // Ensure display is 00:00:00
                showMessageBox('Timer finished!', 'success');
                showNotification('Timer Finished!', 'Your timer has completed.'); // Trigger a notification
                // You could add sound effects here using Tone.js or a simple Audio object
                // Example: new Audio('path/to/timer_alarm.mp3').play();
            }
        }

        /**
         * Resets the timer to zero and stops any active countdown.
         */
        function resetTimer() {
            clearInterval(timerInterval); // Clear any running interval
            timerRunning = false;
            timerTime = 0; // Reset time to zero
            document.getElementById('timerStart').textContent = 'Start'; // Reset button text
            document.getElementById('timerStart').classList.replace('bg-purple-500', 'bg-orange-500');
            document.getElementById('timerStart').classList.replace('bg-green-500', 'bg-orange-500');
            updateTimerDisplay(); // Reset display to 00:00:00 and show inputs
            showMessageBox('Timer reset.', 'success');
        }

        // --- Settings Modal Functions ---

        /**
         * Displays the settings modal and populates its fields with current settings.
         */
        function showSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('timeFormat').value = timeFormat; // Set time format dropdown
            document.getElementById('themeSelect').value = theme; // Set theme dropdown
            updateNotificationToggleUI(); // Update notification toggle visual state
        }

        /**
         * Closes the settings modal.
         */
        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        // Event listeners for settings changes in the modal
        document.getElementById('timeFormat').addEventListener('change', (event) => {
            timeFormat = parseInt(event.target.value); // Update global time format
            saveSettings(); // Save the preference
            updateTime(); // Update main clock immediately
            renderAlarms(); // Alarms list might need re-rendering for time format changes
        });

        document.getElementById('themeSelect').addEventListener('change', (event) => {
            theme = event.target.value; // Update global theme
            applyTheme(theme); // Apply the new theme
            saveSettings(); // Save the preference
            // No need to call renderAlarms/updateWorldClocks here, applyTheme already does it
        });

        /**
         * Updates the visual state of the notification toggle switch in settings.
         */
        function updateNotificationToggleUI() {
            const toggle = document.getElementById('notificationToggle');
            const span = toggle.querySelector('span:last-child'); // The movable circle part of the toggle

            if (notificationsEnabled) {
                toggle.classList.add('bg-orange-500');
                toggle.classList.remove('bg-gray-600');
                span.classList.add('translate-x-6'); // Move circle to the right (ON)
                span.classList.remove('translate-x-1');
            } else {
                toggle.classList.remove('bg-orange-500');
                toggle.classList.add('bg-gray-600');
                span.classList.remove('translate-x-6');
                span.classList.add('translate-x-1'); // Move circle to the left (OFF)
            }
        }

        /**
         * Toggles the application's internal notification setting.
         * Requests permission if not already granted.
         */
        function toggleNotifications() {
            if (Notification.permission === "granted") {
                notificationsEnabled = !notificationsEnabled; // Simply toggle if permission is granted
                showMessageBox(`Notifications ${notificationsEnabled ? 'enabled' : 'disabled'}.`, 'info');
            } else if (Notification.permission === "denied") {
                // If denied, inform the user they need to change browser settings
                showMessageBox('Notifications are blocked by your browser. Please allow them in your browser settings.', 'error');
                notificationsEnabled = false; // Cannot enable if denied by browser
            } else { // Permission is 'default' (not yet asked or explicitly granted/denied)
                requestNotificationPermission(); // Ask for permission
                return; // Exit here, the permission request's callback will update state
            }
            saveSettings(); // Save the updated notification preference
            updateNotificationToggleUI(); // Update the UI of the toggle switch
        }

        // --- Tab Navigation ---

        /**
         * Switches the active tab and updates content visibility.
         * @param {string} tabName - The ID of the tab to activate ('clock', 'alarm', 'stopwatch', 'timer').
         */
        function switchTab(tabName) {
            currentTab = tabName;
            // Hide all tab content sections
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            // Show the selected tab's content
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');

            // Update active state of tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'text-white', 'text-black');
                if (theme === 'light') {
                    btn.classList.add('text-gray-700'); // Inactive color for light theme
                } else {
                    btn.classList.add('text-gray-300'); // Inactive color for dark theme
                }
            });
            const activeBtn = document.querySelector(`.tab-btn[onclick*="${tabName}"]`);
            activeBtn.classList.add('active'); // Mark as active
            if (theme === 'light') {
                activeBtn.classList.remove('text-gray-700');
                activeBtn.classList.add('text-black'); // Active text color for light theme
            } else {
                activeBtn.classList.remove('text-gray-300');
                activeBtn.classList.add('text-white'); // Active text color for dark theme
            }

            updateTabIndicator(); // Animate the tab indicator

            // Perform tab-specific re-renders when switching to ensure fresh data/state
            if (tabName === 'alarm') {
                renderAlarms();
            } else if (tabName === 'clock') {
                updateWorldClocks();
                initializeClockDisplay(); // Ensure correct clock face is displayed
            } else if (tabName === 'stopwatch') {
                updateStopwatch(); // Ensure stopwatch display is accurate on tab switch
            } else if (tabName === 'timer') {
                updateTimerDisplay(); // Ensure timer display is accurate on tab switch
            }
        }

        /**
         * Updates the position and width of the tab indicator to match the active tab button.
         */
        function updateTabIndicator() {
            const tabIndicator = document.getElementById('tabIndicator');
            const activeTabButton = document.querySelector('.tab-btn.active');

            if (activeTabButton) {
                tabIndicator.style.width = `${activeTabButton.offsetWidth}px`; // Set width
                tabIndicator.style.left = `${activeTabButton.offsetLeft}px`; // Set horizontal position
            }
        }

        // --- Initialization on load ---

        /**
         * Initializes the entire application when the DOM is fully loaded.
         */
        function init() {
            loadSettings(); // Load saved preferences first
            initializeClockDisplay(); // Set up initial clock face display
            createHourMarkers(); // Draw analog clock markers
            updateTabIndicator(); // Position the tab indicator correctly
            updateWorldClocks(); // Render initial world clocks
            checkNotificationPermission(); // Check and potentially request notification permissions
            updateTime(); // Initial update for time, date, and hands
            updateDynamicLogo(); // Initial update for dynamic logo based on current time
            getCurrentLocation(); // Get and display current location

            // Set up intervals for continuous updates
            setInterval(updateTime, 1000); // Update time every second
            setInterval(updateDynamicLogo, 60000); // Update logo every minute
            setInterval(checkAlarms, 1000); // Check alarms every second (can be optimized to every minute)
                                        // Keeping it at 1 sec for precise alarm checking.
        }

        // Attach the init function to the DOMContentLoaded event
        document.addEventListener('DOMContentLoaded', init);
        // Also update tab indicator on window resize
        window.addEventListener('resize', updateTabIndicator);
    </script>
</body>
</html>
